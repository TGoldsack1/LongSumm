{
  "sections": [{
    "heading": "1. Introduction",
    "text": "Many sequential decision problems, including diabetes treatment (Bastani, 2014), digital marketing (Theocharous et al., 2015), and robot control (Lillicrap et al., 2015), are modeled as Markov decision processes (MDPs) and solved using reinforcement learning (RL) algorithms. One important problem when applying RL to real problems is policy evaluation. The goal in policy evaluation is to estimate the expected return (sum of rewards) produced by a policy. We refer to this policy as the evaluation policy, πe. The standard policy evaluation approach is to repeatedly deploy πe and average the resulting returns. While this naı̈ve Monte Carlo estimator is unbiased, it may have high variance.\n1The University of Texas at Austin, Austin, Texas, USA 2The University of Massachusetts, Amherst, Massachusetts, USA 3Carnegie Mellon University, Pittsburgh, Pennsylvania, USA. Correspondence to: Josiah P. Hanna <jphanna@cs.utexas.edu>.\nProceedings of the 34 th International Conference on Machine Learning, Sydney, Australia, PMLR 70, 2017. Copyright 2017 by the author(s).\nMethods that evaluate πe while selecting actions according to πe are termed on-policy. Previous work has addressed variance reduction for on-policy returns (Zinkevich et al., 2006; White & Bowling, 2009; Veness et al., 2011). An alternative approach is to estimate the performance of πe while following a different, behavior policy, πb. Methods that evaluate πe with data generated from πb are termed offpolicy. Importance sampling (IS) is one standard approach for using off-policy data in RL. IS reweights returns observed while executing πb such that they are unbiased estimates of the performance of πe.\nPresently, IS is usually used when off-policy data is already available or when executing πe is impractical. If πb is not chosen carefully, IS often has high variance (Thomas et al., 2015). For this reason, an implicit assumption in the RL community has generally been that on-policy evaluation is more accurate when it is feasible. However, IS can also be used for variance reduction when done with an appropriately selected distribution of returns (Hammersley & Handscomb, 1964). While IS-based variance reduction has been explored in RL, this prior work has required knowledge of the environment’s transition probabilities and remains onpolicy (Desai & Glynn, 2001; Frank et al., 2008; Ciosek & Whiteson, 2017). In contrast to this earlier work, we show how careful selection of the behavior policy can lead to lower variance policy evaluation than using the evaluation policy and do not require knowledge of the environment’s transition probabilities.\nIn this paper, we formalize the selection of πb as the behavior policy search problem. We introduce a method for this problem that adapts the policy parameters of πb with gradient descent on the variance of importance-sampling. Empirically we demonstrate behavior policy search with our method lowers the mean squared error of estimates compared to on-policy estimates. To the best of our knowledge, this work is the first to propose adapting the behavior policy to obtain better policy evaluation in RL. Furthermore we present the first method to address this problem."
  }, {
    "heading": "2. Preliminaries",
    "text": "This section details the policy evaluation problem setting, the Monte Carlo and Advantage Sum on-policy methods, and importance-sampling for off-policy evaluation."
  }, {
    "heading": "2.1. Background",
    "text": "We use notational standard MDPNv1 (Thomas, 2015), and for simplicity, we assume that S,A, and R are finite.1 Let H := (S0, A0, R0, S1, . . . , SL, AL, RL) be a trajectory and g(H) := ∑L t=0 γ\ntRt be the discounted return of trajectory H . Let ρ(π) := E[g(H)|H ∼ π] be the expected discounted return when the stochastic policy π is used from S0 sampled from the initial state distribution. In this work, we consider parameterized policies, πθ, where the distribution over actions is determined by the vector θ. We assume that the transitions and reward function are unknown and that L is finite.\nWe are given an evaluation policy, πe, for which we would like to estimate ρ(πe). We assume there exists a policy parameter vector θe such that πe = πθe and that this vector is known. We consider an incremental setting where, at iteration i, we sample a single trajectory Hi with a policy πθi and add {Hi,θi} to a set D. We use Di to denote the set at iteration i. Methods that always (i.e., ∀i) choose θi = θe are on-policy; otherwise, the method is off-policy. A policy evaluation method, PE, uses all trajectories in Di to estimate ρ(πe). Our goal is to design a policy evaluation algorithm that produces estimates of ρ(πe) that have low mean squared error (MSE). Formally, the goal of policy evaluation with PE is to minimize (PE(Di)− ρ(πe))2. While other measures of policy evaluation accuracy could be considered, we follow earlier work in using MSE (e.g., (Thomas & Brunskill, 2016; Precup et al., 2000)).\nWe focus on unbiased estimators of ρ(πe). While biased estimators (e.g., bootstrapping methods (Sutton & Barto, 1998), approximate models (Kearns & Singh, 2002), etc.) can sometimes produce lower MSE estimates they are problematic for high risk applications requiring confidence intervals. For unbiased estimators, minimizing variance is equivalent to minimizing MSE."
  }, {
    "heading": "2.2. Monte-Carlo Estimates",
    "text": "Perhaps the most commonly used policy evaluation method is the on-policy Monte-Carlo (MC) estimator. The estimate of ρ(πe) at iteration i is the average return:\nMC(Di) := 1\ni+ 1 i∑ j=0 L∑ t=0 γtRt = 1 i+ 1 i∑ j=0 g(Hj).\nThis estimator is unbiased and strongly consistent given mild assumptions.2 However, this method can have high variance.\n1The methods, and theoretical results discussed in this paper are applicable to both finite and infinite S,A and R as well as partially-observable Markov decision processes.\n2Being a strongly consistent estimator of ρ(πe) means that"
  }, {
    "heading": "2.3. Advantage Sum Estimates",
    "text": "Like the Monte-Carlo estimator, the advantage sum (ASE) estimator selects θi = θe for all i. However, it introduces a control variate to reduce the variance without introducing bias. This control variate requires an approximate model of the MDP to be provided. Let the reward function of this model be given as r̂(s, a). Let q̂πe(st, at) = E[ ∑L t′=t γ\nt′ r̂(st′ , at′)] and v̂πe(st) = E[q̂πe(st, at)|at ∼ πe], i.e., the action-value function and state-value function of πe in this approximate model. Then, the advantage sum estimator is given by:\nAS(Di) := 1\ni+ 1 i∑ j=0 L∑ t=0 γt(Rt− q̂πe(St, At)+ v̂πe(St)).\nIntuitively, ASE is replacing part of the randomness of the Monte Carlo return with the known expected return under the approximate model. Provided qπe(St, At)− v̂πe(St) is sufficiently correlated with Rt, the variance of ASE is less than that of MC.\nNotice that, like the MC estimator, the ASE estimator is on-policy, in that the behavior policy is always the policy that we wish to evaluate. Intuitively it may seems like this choice should be optimal. However, we will show that it is not—selecting behavior policies that are different from the evaluation policy can result in estimates of ρ(πe) that have lower variance."
  }, {
    "heading": "2.4. Importance Sampling",
    "text": "Importance Sampling is a method for reweighting returns from a behavior policy, θ, such that they are unbiased returns from the evaluation policy. In RL, the re-weighted IS return of a trajectory, H , sampled from πθ is:\nIS(H,θ) := g(H) L∏ t=0 πe(St|At) πθ(St|At) .\nThe IS off-policy estimator is then a Monte Carlo estimate of E [IS(H,θ)|H ∼ πθ]:\nIS(Di) := 1\ni+ 1 i∑ j=0 IS(Hj ,θj).\nIn RL, importance sampling allows off-policy data to be used as if it were on-policy. In this case the variance of the IS estimate is often much worse than the variance of on-policy MC estimates because the behavior policy is not\nPr ( lim i→∞ MC(Di) = ρ(πe) ) = 1. If ρ(πe) exists, MC is strongly consistent by the Khintchine Strong law of large numbers (Sen & Singer, 1993).\nchosen to minimize variance, but is a policy that is dictated by circumstance."
  }, {
    "heading": "3. Behavior Policy Search",
    "text": "Importance sampling was originally intended as a variance reduction technique for Monte Carlo evaluation (Hammersley & Handscomb, 1964). When an evaluation policy rarely samples trajectories with high magnitude returns a Monte Carlo evaluation will have high variance. If a behavior policy can increase the probability of observing such trajectories then the off-policy IS estimate will have lower variance than an on-policy Monte Carlo estimate. In this section we first describe the theoretical potential for variance reduction with an appropriately selected behavior policy. In general this policy will be unknown. Thus, we propose a policy evaluation subproblem — the behavior policy search problem — solutions to which will adapt the behavior policy to provide lower mean squared error policy performance estimates. To the best of our knowledge, we are the first to propose behavior policy adaptation for policy evaluation."
  }, {
    "heading": "3.1. The Optimal Behavior Policy",
    "text": "An appropriately selected behavior policy can lower variance to zero. While this fact is generally known for importance-sampling, we show here that this policy exists for any MDP and evaluation policy under two restrictive assumptions: all returns are positive and the domain is deterministic. In the following section we describe how an initial policy can be adapted towards the optimal behavior policy even when these conditions fail to hold.\nLet wπ(H) := ∏L t=0 π(At|St). Consider a behavior policy π?b such that for any trajectory, H:\nρ(πe) = IS(H,π ? b ) = g(H)\nwπe(H) wπ?b (H) .\nRearranging the terms of this expressions yields:\nwπ?b (H) = g(H) wπe(H)\nρ(πe) .\nThus, if we can select π?b such that the probability of observing any H ∼ π?b is g(H) ρ(πe)\ntimes the likelihood of observing H ∼ πe then the IS estimate has zero MSE with only a single sampled trajectory. Regardless of g(H), the importance-sampled return will equal ρ(πe).\nFurthermore, the policy π?b exists within the space of all feasible stochastic policies. Consider that a stochastic policy can be viewed as a mixture policy over time-dependent (i.e., action selection depends on the current time-step) deterministic policies. For example, in an MDP with one state, two actions and a horizon of L there are 2L possible time-dependent deterministic policies, each of which\ndefines a unique sequence of actions. We can express any evaluation policy as a mixture of these deterministic policies. The optimal behavior policy π?b can be expressed similarly and thus the optimal behavior policy exists.\nUnfortunately, the optimal behavior policy depends on the unknown value ρ(πe) as well as the unknown reward function R (via g(H)). Thus, while there exists an optimal behavior policy for IS – which is not πe – in practice we cannot analytically determine π?b . Additionally, π ? b may not be representable by any θ in our policy class."
  }, {
    "heading": "3.2. The Behavior Policy Search Problem",
    "text": "Since the optimal behavior policy cannot be analytically determined, we instead propose the behavior policy search (BPS) problem for finding πb that lowers the MSE of estimates of ρ(πe). A BPS problem is defined by the inputs:\n1. An evaluation policy πe with policy parameters θe. 2. An off-policy policy evaluation algorithm,\nOPE(H,θ), that takes a trajectory, H ∼ πθ, or, alternatively, a set of trajectories, and returns an estimate of ρ(πe).\nA BPS solution is a policy, πθb such that off-policy estimates with OPE have lower MSE than on-policy estimates. Methods for this problem are BPS algorithms.\nRecall we have formalized policy evaluation within an incremental setting where one trajectory for policy evaluation is generated each iteration. At the ith iteration, a BPS algorithm selects a behavior policy that will be used to generate a trajectory, Hi. The policy evaluation algorithm, OPE, then estimates ρ(πe) using trajectories in Di. Naturally, the selection of the behavior policy depends on how OPE estimates ρ(πe).\nIn a BPS problem, the ith iteration proceeds as follows. First, given all of the past behavior policies, {θi}i−1i=0, and the resulting trajectories, {Hi}i−1i=0, the BPS algorithm must select θi. The policy πθi is then run for one episode to create the trajectory Hi. Then the BPS algorithm uses OPE to estimate ρ(πe) given the available data, Di := {(θi, Hi)}ii=0. In this paper, we consider the one-step problem of selecting θi and estimating ρ(πe) at iteration i in a way that minimizes MSE. That is, we do not consider how our selection of θi will impact our future ability to select an appropriate θj for j > i and thus to produce more accurate estimates in the future.\nOne natural question is: if we are given a limit on the number of trajectories that can be sampled, is it better to “spend” some of our limited trajectories on BPS instead of using on-policy estimates? Since each OPE(Hi,θi) is an unbiased estimator of ρ(πe), we can use all sampled trajectories to compute OPE(Di). Provided for all itera-\ntions, Var[OPE(H,θi)] ≤ V ar[MC] then, in expectation, a BPS algorithm will always achieve lower MSE than MC, showing that it is, in fact, worthwhile to do so. This claim is supported by our empirical study."
  }, {
    "heading": "4. Behavior Policy Gradient Theorem",
    "text": "We now introduce our primary contributions: an analytic expression for the gradient of the mean squared error of the IS estimator and a stochastic gradient descent algorithm that adapts θ to minimize the MSE between the IS estimate and ρ(πe). Our algorithm — Behavior Policy Gradient (BPG) — begins with on-policy estimates and adapts the behavior policy with gradient descent on the MSE with respect to θ. The gradient of the MSE with respect to the policy parameters is given by the following theorem: Theorem 1.\n∂\n∂θ MSE[IS(H,θ)] = E\n[ − IS(H,θ)2\nL∑ t=0 ∂ ∂θ log πθ(At|St)\n]\nwhere the expectation is taken over H ∼ πθ.\nProof. Proofs for all theoretical results are included in Appendix A of an extended version available at http: //arxiv.org/abs/1706.03469.\nBPG uses stochastic gradient descent in place of exact gradient descent: replacing the intractable expectation in Theorem 1 with an unbiased estimate of the true gradient. In our experiments, we sample a batch, Bi, of k trajectories with πθi to lower the variance of the gradient estimate at iteration i. In the BPS setting, sampling a batch of trajectories is equivalent to holding θ fixed for k iterations and then updating θ with the k most recent trajectories used to compute the gradient estimate.\nFull details of BPG are given in Algorithm 1. At iteration i, BPG samples a batch, Bi, of k trajectories and adds {(θi, Hi)ki=0} to a data set D (Lines 4-5). Then BPG updates θ with an empirical estimate of Theorem 1 (Line 6). After n iterations, the BPG estimate of ρ(πe) is IS(Dn) as defined in Section 2.4.\nGiven that the step-size, αi, is consistent with standard gradient descent convergence conditions, BPG will converge to a behavior policy that locally minimizes the variance (Bertsekas & Tsitsiklis, 2000). At best, BPG converges to the globally optimal behavior policy within the parameterization of πe. Since the parameterization of πe determines the class of representable distributions it is possible that the theoretically optimal behavior policy is unrepresentable under this parameterization. Nevertheless, a suboptimal behavior policy still yields better estimates of ρ(πe), provided it decreases variance compared to on-policy returns.\nAlgorithm 1 Behavior Policy Gradient Input: Evaluation policy parameters, θe, batch size k, a step-size for each iteration, αi, and number of iterations n. Output: Final behavior policy parameters θn and the IS estimate of ρ(πe) using all sampled trajectories. 1: θ0 ← θe 2: D0 = {} 3: for all i ∈ 0...n do 4: Bi = Sample k trajectories H ∼ πθi 5: Di+1 = Di ∪ Bi\n6: θi+1 = θi + αik ∑ H∈B IS(H,θ)2 L∑ t=0 ∂ ∂θ log πθi(At|St) 7: end for 8: Return θn, IS(Dn)"
  }, {
    "heading": "4.1. Control Variate Extension",
    "text": "In cases where an approximate model is available, we can further lower variance adapting the behavior policy of the doubly robust estimator (Jiang & Li, 2016; Thomas & Brunskill, 2016). Based on a similar intuition as the Advantage Sum estimator (Section 2.3), the Doubly Robust (DR) estimator uses the value functions of an approximate model as a control variate to lower the variance of importancesampling.3 We show here that we can adapt the behavior policy to lower the mean squared error of DR estimates. We denote this new method DR-BPG for Doubly Robust Behavior Policy Gradient.\nLet wπ,t(H) = ∏t i=0 π(At|St) and recall that v̂πe and q̂πe are the state and action value functions of πe in the approximate model. The DR estimator is:\nDR(H,θ) := v̂(S0)+ L∑ t=0 wπe,t wπθ ,t (Rt−q̂πe(St, At)+v̂πe(St+1)).\nWe can reduce the mean squared error of DR with gradient descent using unbiased estimates of the following corollary to Theorem 1: Corollary 1.\n∂\n∂θ MSE [DR(H,θ)] = E[(DR(H,θ)2 L∑ t=0 ∂ ∂θ log πθ(At|St)\n− 2DR(H,θ)( L∑ t=0 γtδt wπe,t wθ,t t∑ i=0 ∂ ∂θ log πθ(Ai|Si))]\nwhere δt = Rt− q̂(St, At) + v̂(St+1) and the expectation is taken over H ∼ πθ.\nThe first term of ∂∂θMSE is analogous to the gradient of the importance-sampling estimate with IS(H,θ) replaced\n3DR lowers the variance of per-decision importance-sampling which importance samples the per time-step reward.\nby DR(H,θ). The second term accounts for the covariance of the DR terms.\nAS and DR both assume access to a model, however, they make no assumption about where the model comes from except that it must be independent of the trajectories used to compute the final estimate. In practice, AS and DR perform best when all trajectories are used to estimate the model and then used to estimate ρ(πe) (Thomas & Brunskill, 2016). However, for DR-BPG, changes to the model change the surface of the MSE objective we seek to minimize and thus DR-BPG will only converge once the model stops changing. In our experiments, we consider both a changing and a fixed model."
  }, {
    "heading": "4.2. Connection to REINFORCE",
    "text": "BPG is closely related to existing work in policy gradient RL (c.f., (Sutton et al., 2000)) and we draw connections between one such method and BPG to illustrate how BPG changes the distribution of trajectories. REINFORCE (Williams, 1992) attempts to maximize ρ(πθ) through gradient ascent on ρ(πθ) using the following unbiased gradient of ρ(πθ):\n∂\n∂θ ρ(πθ) = E\n[ g(H)\nL∑ t=0 ∂ ∂θ log πθ(At|St) ∣∣∣∣∣H ∼ πθ ] .\nIntuitively, REINFORCE increases the probability of all actions taken during H as a function of g(H). This update increases the probability of actions that lead to high return trajectories. BPG can be interpreted as REINFORCE where the return of a trajectory is the square of its importance-sampled return. Thus BPG increases the probability of all actions taken along H as a function of IS(H,θ)2. The magnitude of IS(H,θ)2 depends on two qualities of H:\n1. g(H)2 is large (i.e., a high magnitude event). 2. H is rare relative to its probability under the evalua-\ntion policy (i.e., ∏L t=0 πe(At|St) πθ(At|St) is large).\nThese two qualities demonstrate a balance in how BPG changes trajectory probabilities. Increasing the probability of a trajectory under πθ will decrease IS(H,θ)2 and so BPG increases the probability of a trajectory when g(H)2 is large enough to offset the decrease in IS(H,θ)2 caused by decreasing the importance weight."
  }, {
    "heading": "5. Empirical Study",
    "text": "This section presents an empirical study of variance reduction through behavior policy search. We design our experiments to answer the following questions:\n• Can behavior policy search with BPG reduce policy evaluation MSE compared to on-policy estimates in\nboth tabular and continuous domains? • Does adapting the behavior policy of the Doubly Ro-\nbust estimator with DR-BPG lower the MSE of the Advantage Sum estimator? • Does the rarety of actions that cause high magnitude rewards affect the performance gap between BPG and Monte Carlo estimates?"
  }, {
    "heading": "5.1. Experimental Set-up",
    "text": "We address our first experimental question by evaluating BPG in three domains. We briefly describe each domain here; full details are available in appendix C.\nThe first domain is a 4x4 Gridworld. We obtain two evaluation policies by applying REINFORCE to this task, starting from a policy that selects actions uniformly at random. We then select one evaluation policy, π1, from the early stages of learning – an improved policy but still far from converged – and one after learning has converged, π2. We run all experiments once with πe := π1 and a second time with πe := π2.\nOur second and third tasks are the continuous control Cartpole Swing Up and Acrobot tasks implemented within RLLAB (Duan et al., 2016). The evaluation policy in each domain is a neural network that maps the state to the mean of a Gaussian distribution. Policies are partially optimized with trust-region policy optimization (Schulman et al., 2015) applied to a randomly initialized policy."
  }, {
    "heading": "5.2. Main Results",
    "text": "Gridworld Experiments Figure 1 compares BPG to Monte Carlo for both Gridworld policies, π1 and π2. Our main point of comparison is the mean squared error (MSE) of both estimates at iteration i over 100 trials. For π1, BPG significantly reduces the MSE of on-policy estimates (Figure 1a). For π2, BPG also reduces MSE, however, it is only a marginal improvement.\nAt the end of each trial we used the final behavior policy to collect 100 more trajectories and estimate ρ(πe). In comparison to a Monte Carlo estimate with 100 trajectories from π1, MSE is 85.48 % lower with this improved behavior policy. For π2, the MSE is 31.02 % lower. This result demonstrates that BPG can find behavior policies that substantially lower MSE.\nTo understand the disparity in performance between these two instances of policy evaluation, we plot the distribution of g(H) under πe (Figures 1c and 1d). These plots show the variance of π1 to be much higher; it sometimes samples returns with twice the magnitude of any sampled by π2. To quantify this difference, we also measure the variance of IS(H,θi) as E [ IS(H)2\n∣∣H ∼ πθi]−E [IS(H)|H ∼ πθi ]2 where the expectations are estimated with 10,000 trajecto-\nries. This evaluation is repeated 5 times per iteration and the reported variance is the mean over these evaluations. The decrease in variance for each policy is shown in Figure 1e. The high initial variance means there is much more room for BPG to improve the behavior policy when θe is the partially optimized policy.\nWe also test the sensitivity of BPG to the learning rate parameter. A critical issue in the use of BPG is selecting the\nstep size parameter α. If α is set too high we risk making too large of an update to θ — potentially stepping to a worse behavior policy. If we are too conservative then it will take many iterations for a noticeable improvement over Monte Carlo estimation. Figure 1f shows variance reduction for a number of different α values in the GridWorld domain. We found BPG in this domain was robust to a variety of step size values. We do not claim this result is representative for all problem domains; stepsize selection in the behavior policy search problem is an important area for future work.\nContinuous Control Figure 2 shows reduction of MSE on the Cartpole Swing-up and Acrobot domains. Again we see that BPG reduces MSE faster than Monte Carlo evaluation. In contrast to the discrete Gridworld experiment, this experiment demonstrates the applicability of BPG to the continuous control setting. While BPG significantly outperforms Monte Carlo evaluation in Cart-pole Swingup, the gap is much smaller in Acrobot. This result also demonstrates BPG (and behavior policy search) when the policy must generalize across different states."
  }, {
    "heading": "5.3. Control Variate Extensions",
    "text": "In this section, we evaluate the combination of modelbased control variates with behavior policy search. Specifically, we compare the AS estimator with Doubly Robust BPG (DR-BPG). In these experiments we use a 10x10 stochastic gridworld. The added stochasticity increases the difficulty of building an accurate model from trajectories.\nSince these methods require a model we construct this model in one of two ways. The first method uses all trajectories in D to build the model and then uses the same set to estimate ρ(πe) with ASE or DR. The second method uses trajectories from the first 10 iterations to build the model and then fixes the model for the remaining iterations. For DR-BPG, behavior policy search starts at iteration 10 un-\nder this second condition. We call the first method “update” and the second method “fixed.” The update method invalidates the theoretical guarantees of these methods but learns a more accurate model. In both instances, we build maximum likelihood tabular models.\nFigure 3 demonstrates that combining BPG with a modelbased control variate (DR-BPG) can lead to further reduction of MSE compared to the control variate alone (ASE). Specifically, with the fixed model, DR-BPG outperformed all other methods. DR-BPG using the update method for building the model performed competitively with ASE although not statistically significantly better. We also evaluate the final learned behavior policy of the fixed model variant of DR-BPG. For a batch size of 100 trajectories, the DR estimator with this behavior policy improves upon the ASE estimator with the same model by 56.9 %.\nFor DR-BPG, estimating the model with all data still allowed steady progress towards lower variance. This result is interesting since a changing model changes the surface of our variance objective and thus gradient descent on the variance has no theoretical guarantees of convergence. Empirically, we observe that setting the learning rate for DRBPG was more challenging for either model type. Thus while we have shown BPG can be combined with control variates, more work is needed to produce a robust method."
  }, {
    "heading": "5.4. Rareness of Event",
    "text": "Our final experiment aims to understand how the gap between on- and off-policy variance is affected by the probability of rare events. The intuition for why behavior policy search can lower the variance of on-policy estimates is that a well selected behavior policy can cause rare and high magnitude events to occur. We test this intuition by varying the probability of a rare, high magnitude event and observing how this change affects the performance gap between on- and off-policy evaluation. For this experiment, we use a variant of the deterministic Gridworld where taking the UP action in the initial state (the upper left corner) causes a transition to the terminal state with a reward of +50. We use π1 from our earlier Gridworld experiments but we vary the probability of choosing UP when in the initial state. So with probability p the agent will receive a large reward and end the trajectory. We use a constant learning rate of 10−5 for all values of p and run BPG for 500 iterations. We plot the relative decrease of the variance as a function of p over 100 trials for each value of p. We use relative variance to normalize across problem instances. Note that under this measure, even when p is close to 1, the relative variance is not equal to zero because as p approaches 1 the initial variance also goes to zero.\nThis experiment illustrates that as the initial variance increases, the amount of improvement BPG can achieve increases. As p becomes closer to 1, the initial variance becomes closer to zero and BPG barely improves over the variance of Monte Carlo (in terms of absolute variance there is no improvement). When the πe rarely takes the high rewarding UP action (p close to 0), BPG improves policy evaluation by increasing the probability of this action. This experiment supports our intuition for why off-policy evaluation can outperform on-policy evaluation."
  }, {
    "heading": "6. Related Work",
    "text": "Behavior policy search and BPG are closely related to existing work on adaptive importance-sampling. While adaptive importance-sampling has been studied in the estimation literature, we focus here on adaptive importancesampling for MDPs and Markov Reward Processes (i.e., an MDP with a fixed policy). Existing work on adaptive IS in RL has considered changing the transition probabilities to lower the variance of policy evaluation (Desai & Glynn, 2001; Frank et al., 2008) or lower the variance of policy gradient estimates (Ciosek & Whiteson, 2017). Since the transition probabilities are typically unknown in RL, adapting the behavior policy is a more general approach to adaptive IS. Ciosek and Whiteson also adapt the distribution of trajectories with gradient descent on the variance (Ciosek & Whiteson, 2017) with respect to parameters of the transition probabilities. The main focus of this work is increasing\nthe probability of simulated rare events so that policy improvement can learn an appropriate response. In contrast, we address the problem of policy evaluation and differentiate with respect to the (known) policy parameters.\nThe cross-entropy method (CEM) is a general method for adaptive importance-sampling. CEM attempts to minimize the Kullback-Leibler divergence between the current sampling distribution and the optimal sampling distribution. As discussed in Section 3.1, this optimal behavior policy only exists under a set of restrictive conditions. In contrast we adapt the behavior policy by minimizing variance.\nOther methods exist for lowering the variance of on-policy estimates. In addition to the control variate technique used by the Advantage Sum estimator (Zinkevich et al., 2006; White & Bowling, 2009), Veness et al. consider using common random numbers and antithetic variates to reduce the variance of roll-outs in Monte Carlo Tree Search (MCTS) (2011). These techniques require a model of the environment (as is typical for MCTS) and do not appear to be applicable to the general RL policy evaluation problem. BPG could potentially be applied to find a lower variance rollout policy for MCTS.\nIn this work we have focused on unbiased policy evaluation. When the goal is to minimize MSE it is often permissible to use biased methods such as temporal difference learning (van Seijen & Sutton, 2014), model-based policy evaluation (Kearns & Singh, 2002; Strehl et al., 2009), or variants of weighted importance sampling (Precup et al., 2000). It may be possible to use similar ideas to BPG to reduce bias and variance although this appears to be difficult since the bias contribution to the mean squared error is squared and thus any gradient involving bias requires knowledge of the estimator’s bias. We leave behavior policy search with biased off-policy methods to future work."
  }, {
    "heading": "7. Discussion and Future Work",
    "text": "Our experiments demonstrate that behavior policy search with BPG can lower the variance of policy evaluation. One open question is characterizing the settings where adapting the behavior policy substantially improves over on-policy estimates. Towards answering this question, our Gridworld experiment showed that when πe has little variance, BPG can only offer marginal improvement. BPG increases the probability of observing rare events with a high magnitude. If the evaluation policy never sees such events then there is little benefit to using BPG. However, in expectation and with an appropriately selected step-size, BPG will never lower the data-efficiency of policy evaluation.\nIt is also necessary that the evaluation policy contributes to the variance of the returns. If all variance is due to the environment then it seems unlikely that BPG will offer much\nimprovement. For example, Ciosek and Whiteson (2017) consider a variant of the Mountain Car task where the dynamics can trigger a rare event — independent of the action — in which rewards are multiplied by 1000. No behavior policy adaptation can lower the variance due to this event.\nOne limitation of gradient-based BPS methods is the necessity of good step-size selection. In theory, BPG can never lead to worse policy evaluation compared to on-policy estimates. In practice, a poorly selected step-size may cause a step to a worse behavior policy at step iwhich may increase the variance of the gradient estimate at step i + 1. Future work could consider methods for adaptive step-sizes, second order methods, or natural behavior policy gradients.\nOne interesting direction for future work is incorporating behavior policy search into policy improvement. A similar idea was explored by Ciosek and Whiteson who explored off-environment learning to improve the performance of policy gradient methods (2017). The method presented in that work is limited to simulated environments with differential dynamics. Adapting the behavior policy is a potentially much more general approach."
  }, {
    "heading": "8. Conclusion",
    "text": "We have introduced the behavior policy search problem in order to improve estimation of ρ(πe) for an evaluation policy πe. We present a solution — Behavior Policy Gradient — for this problem which adapts the behavior policy with stochastic gradient descent on the variance of the importance-sampling estimator. Experiments demonstrate BPG lowers the mean squared error of estimates of ρ(πe) compared to on-policy estimates. We also demonstrate BPG can further decrease the MSE of estimates in conjunction with a model-based control variate method."
  }, {
    "heading": "9. Acknowledgements",
    "text": "We thank Daniel Brown and the anonymous reviewers for useful comments on the work and its presentation. This work has taken place in the Personal Autonomous Robotics Lab (PeARL) and Learning Agents Research Group (LARG) at the Artificial Intelligence Laboratory, The University of Texas at Austin. PeARL research is supported in part by NSF (IIS-1638107, IIS-1617639). LARG research is supported in part by NSF (CNS-1330072, CNS-1305287, IIS-1637736, IIS-1651089), ONR (21C184-01), AFOSR (FA9550-14-1-0087), Raytheon, Toyota, AT&T, and Lockheed Martin. Josiah Hanna is supported by an NSF Graduate Research Fellowship. Peter Stone serves on the Board of Directors of Cogitai, Inc. The terms of this arrangement have been reviewed and approved by the University of Texas at Austin in accordance with its policy on objectivity in research."
  }],
  "year": 2017,
  "references": [{
    "title": "Model-free intelligent diabetes management using machine learning",
    "authors": ["Bastani", "Meysam"],
    "venue": "PhD thesis, Masters thesis, Department of Computing Science, University of Alberta,",
    "year": 2014
  }, {
    "title": "Gradient convergence in gradient methods with erros",
    "authors": ["Bertsekas", "Dimitri P", "Tsitsiklis", "John N"],
    "year": 2000
  }, {
    "title": "OFFER: Offenvironment reinforcement learning",
    "authors": ["Ciosek", "Kamil", "Whiteson", "Shimon"],
    "venue": "In Proceedings of the 31st AAAI Conference on Artificial Intelligence (AAAI),",
    "year": 2017
  }, {
    "title": "Simulation in optimization and optimization in simulation: A Markov chain perspective on adaptive Monte Carlo algorithms",
    "authors": ["Desai", "Paritosh Y", "Glynn", "Peter W"],
    "venue": "In Proceedings of the 33rd conference on Winter simulation,",
    "year": 2001
  }, {
    "title": "Benchmarking deep reinforcement learning for continuous control",
    "authors": ["Duan", "Yan", "Chen", "Xi", "Houthooft", "Rein", "Schulman", "John", "Abbeel", "Pieter"],
    "venue": "Proceedings of the 33rd International Conference on Machine Learning,",
    "year": 2016
  }, {
    "title": "Reinforcement learning in the presence of rare events",
    "authors": ["Frank", "Jordan", "Mannor", "Shie", "Precup", "Doina"],
    "venue": "In Proceedings of the 25th International Conference on Machine learning,",
    "year": 2008
  }, {
    "title": "Monte Carlo methods, methuen & co",
    "authors": ["JM Hammersley", "Handscomb", "DC"],
    "venue": "Ltd., London, pp",
    "year": 1964
  }, {
    "title": "Doubly robust off-policy evaluation for reinforcement learning",
    "authors": ["Jiang", "Nan", "Li", "Lihong"],
    "venue": "In Proceedings of the 33rd International Conference on Machine Learning (ICML),",
    "year": 2016
  }, {
    "title": "Near-optimal reinforcement learning in polynomial time",
    "authors": ["Kearns", "Michael", "Singh", "Satinder"],
    "venue": "Machine Learning,",
    "year": 2002
  }, {
    "title": "Continuous control with deep reinforcement learning",
    "authors": ["Lillicrap", "Timothy P", "Hunt", "Jonathan J", "Pritzel", "Alexander", "Heess", "Nicolas", "Erez", "Tom", "Tassa", "Yuval", "Silver", "David", "Wierstra", "Daan"],
    "venue": "CoRR, abs/1509.02971,",
    "year": 2015
  }, {
    "title": "Eligibility traces for off-policy policy evaluation",
    "authors": ["D. Precup", "R.S. Sutton", "S. Singh"],
    "venue": "In Proceedings of the 17th International Conference on Machine Learning,",
    "year": 2000
  }, {
    "title": "Trust region policy optimization",
    "authors": ["Schulman", "John", "Levine", "Sergey", "Moritz", "Philipp", "Jordan", "Michael", "Abbeel", "Pieter"],
    "venue": "In Proceedings of the 32nd International Conference on Machine Learning ( ICML),",
    "year": 2015
  }, {
    "title": "Large Sample Methods in Statistics: An Introduction with Applications",
    "authors": ["P.K. Sen", "J.M. Singer"],
    "year": 1993
  }, {
    "title": "Reinforcement learning in finite mdps: PAC analysis",
    "authors": ["Strehl", "Alexander L", "Li", "Lihong", "Littman", "Michael L"],
    "venue": "Journal of Machine Learning Research,",
    "year": 2009
  }, {
    "title": "Reinforcement Learning: An Introduction",
    "authors": ["Sutton", "Richard S", "Barto", "Andrew G"],
    "year": 1998
  }, {
    "title": "Policy gradient methods for reinforcement learning with function approximation",
    "authors": ["Sutton", "Richard S", "McAllester", "David", "Singh", "Satinder", "Mansour", "Yishay"],
    "venue": "In Proceedings of the 13th Conference on Neural Information Processing Systems (NIPS),",
    "year": 2000
  }, {
    "title": "A notation for Markov decision processes",
    "authors": ["Thomas", "Philip S"],
    "venue": "ArXiv, arXiv:1512.09075v1,",
    "year": 2015
  }, {
    "title": "Data-efficient off-policy policy evaluation for reinforcement learning",
    "authors": ["Thomas", "Philip S", "Brunskill", "Emma"],
    "venue": "In Proceedings of the 33rd International Conference on Machine Learning (ICML),",
    "year": 2016
  }, {
    "title": "High confidence off-policy evaluation",
    "authors": ["Thomas", "Philip S", "Theocharous", "Georgios", "Ghavamzadeh", "Mohammad"],
    "venue": "In Proceedings of the AAAI Conference on Artificial Intelligence (AAAI),",
    "year": 2015
  }, {
    "title": "True online TD (λ)",
    "authors": ["van Seijen", "Harm", "Sutton", "Richard S"],
    "venue": "In Proceedings of the 31st International Conference on Machine Learning (ICML),",
    "year": 2014
  }, {
    "title": "Variance reduction in Monte-Carlo tree search",
    "authors": ["J. Veness", "M. Lanctot", "M. Bowling"],
    "venue": "In Proceedings of the 24th Conference on Neural Information Processing Systems,",
    "year": 2011
  }, {
    "title": "Learning a value analysis tool for agent evaluation",
    "authors": ["M. White", "M. Bowling"],
    "venue": "In Proceedings of the 21st International Joint Conference on Artificial Intelligence (IJCAI),",
    "year": 1976
  }, {
    "title": "Simple statistical gradient-following algorithms for connectionist reinforcement learning",
    "authors": ["Williams", "Ronald J"],
    "venue": "Machine learning,",
    "year": 1992
  }, {
    "title": "Optimal unbiased estimators for evaluating agent performance",
    "authors": ["M. Zinkevich", "M. Bowling", "N. Bard", "M. Kan", "D. Billings"],
    "venue": "In Proceedings of the 21st National Conference on Artificial Intelligence (AAAI),",
    "year": 2006
  }],
  "id": "SP:59e2f6daed597db84ca2d7572333e6b39f9bfa62",
  "authors": [{
    "name": "Josiah P. Hanna",
    "affiliations": []
  }, {
    "name": "Philip S. Thomas",
    "affiliations": []
  }, {
    "name": "Peter Stone",
    "affiliations": []
  }, {
    "name": "Scott Niekum",
    "affiliations": []
  }],
  "abstractText": "We consider the task of evaluating a policy for a Markov decision process (MDP). The standard unbiased technique for evaluating a policy is to deploy the policy and observe its performance. We show that the data collected from deploying a different policy, commonly called the behavior policy, can be used to produce unbiased estimates with lower mean squared error than this standard technique. We derive an analytic expression for the optimal behavior policy—the behavior policy that minimizes the mean squared error of the resulting estimates. Because this expression depends on terms that are unknown in practice, we propose a novel policy evaluation sub-problem, behavior policy search: searching for a behavior policy that reduces mean squared error. We present a behavior policy search algorithm and empirically demonstrate its effectiveness in lowering the mean squared error of policy performance estimates.",
  "title": "Data-Efficient Policy Evaluation Through Behavior Policy Search"
}